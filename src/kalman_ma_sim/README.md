# Kalman Moving Average Trading Strategy Simulation

このディレクトリには、カルマンフィルターを使用したビットコイン移動平均トレーディング戦略の実装とバックテストシステムが含まれています。

## 概要

このプロジェクトは、カルマンフィルターを使用してビットコインの価格データから動的移動平均（Kalman MA）を計算し、SMAとのクロスオーバーシグナルを生成してトレーディング戦略を構築しています。Optunaを使用したハイパーパラメータ最適化機能も含まれています。

## ファイル構成

### コアファイル

- **`kfma_core.py`**: コア機能モジュール（純粋関数のみ）
  - カルマンフィルター移動平均の計算
  - シグナル生成
  - ベクトル化されたPnL計算
  - パフォーマンス指標の計算
  - データセット読み込み機能

- **`run_backtest.py`**: CLIラッパー
  - バックテストとパラメータ最適化の実行
  - コマンドライン引数の処理
  - 結果の可視化

- **`btc_kalman_ma_calc.csv`**: ビットコインの価格・指標データ

## 主要機能

### 1. カルマンフィルター移動平均（Kalman MA Model 3）

Benhamou (2016)の2次元カルマンフィルターモデルを実装：
- ATRベースの動的プロセスノイズ
- 価格正規化による数値安定性
- 2成分状態空間モデル

### 2. トレーディングシグナル

```python
# ロングエントリー条件
long_entry = (
    (kma.shift(1) < sma.shift(1)) &     # 前バーでKMA < SMA
    (kma >= sma) &                      # 現バーでクロス確定
    (slope.shift(1) > 0) &              # KMAの傾きが正
    atr_filter.shift(1)                 # ATRフィルター通過
)
```

### 3. リスク管理

- **ストップロス**: ATRの倍数で設定
- **テイクプロフィット**: ATRの倍数で設定
- **トレーリングストップ**: ATRベースの動的ストップ（v3）
- **手数料**: テイカー手数料0.055%
- **スリッページ**: 1bp

### 4. パフォーマンス指標

- **Sharpe比率**: 年率換算リスク調整済みリターン
- **Calmar比率**: 累積リターン/最大ドローダウン（v3）
- **最大ドローダウン**: 最大下落率
- **PBO (Probability of Backtest Overfitting)**: オーバーフィッティング確率（v3）
- **勝率**: 勝ちトレード比率
- **取引回数**: 執行された取引数

### 5. Optuna最適化

最適化対象パラメータ：
- `atr_pct`: ATRフィルターのパーセンタイル（0.30-0.70）
- `slope_m`: KMAスロープ計算期間（2-6）
- `beta_kma`: カルマンフィルターのATRスケール係数（0.5-2.0）
- `sl_mult`: ストップロス倍数（1.0-2.5）
- `tp_mult`: テイクプロフィット倍数（2.0-5.0）

目的関数（v3）:
```
score = 0.5×Sharpe + 0.5×Calmar - PBO - penalty_trades
penalty_trades = exp(max(0, 100-取引数)/15) - 1
```

## 使用方法

### 基本的な実行

```bash
python run_backtest.py \
  --train 2024-01-01 2024-12-31 \
  --test 2025-01-01 2025-05-20 \
  --trials 600
```

実行すると、同じディレクトリに以下のグラフファイルが自動生成されます：
- `backtest_train_YYYYMMDD_HHMMSS.png` - 学習期間の分析結果
- `backtest_test_YYYYMMDD_HHMMSS.png` - テスト期間の分析結果

### パラメータ

- `--train START END`: 学習期間の開始日と終了日
- `--test START END`: テスト期間の開始日と終了日
- `--trials N`: Optuna最適化の試行回数（デフォルト: 800）
- `--csv FILE`: データファイルパス（デフォルト: btc_kalman_ma_calc.csv）

## データ要件

CSVファイルに以下の列が必要：
- `start_at`: タイムスタンプ
- `close`: 終値
- `sma`: 単純移動平均
- `atr`: Average True Range
- `rsi`: RSI指標（自動計算可能）

## 出力

1. **最適パラメータ**: 学習期間での最適なパラメータセット
2. **学習期間パフォーマンス**: in-sample結果
3. **テスト期間パフォーマンス**: out-of-sample結果
4. **可視化グラフファイル**: 高解像度PNG形式（300 DPI）で保存

### 生成されるグラフの詳細

各グラフファイルには3つのパネルで構成された時系列分析が含まれます：

#### パネル1: 累積リターン曲線（Cumulative Return %）
- **縦軸**: 累積リターン率（%）
- **内容**: 戦略の累積パフォーマンスの推移
- **解釈**:
  - 右肩上がり = 利益を積み重ねている
  - 平坦 = パフォーマンス停滞
  - 下降 = 損失が発生

#### パネル2: ドローダウン（DrawDown %）
- **縦軸**: ドローダウン率（%）
- **内容**: 過去最高値からの下落幅の推移
- **表示**: 赤色の塗りつぶしエリア
- **解釈**:
  - 深いドローダウン = 大きなリスク
  - 0%近く = 新高値更新中
  - 最大値 = 最大ドローダウン（MaxDD）

#### パネル3: ローリングSharpe比率（Rolling Sharpe）
- **縦軸**: Sharpe比率
- **内容**: 7日間（168時間）移動窓でのリスク調整済みリターン
- **色**: 紫色のライン
- **解釈**:
  - 1.0以上 = 優秀なリスク調整済みリターン
  - 0付近 = リスクに見合わないリターン
  - マイナス = リスクフリーレート以下のパフォーマンス

### ファイル命名規則

```
backtest_{期間}_{タイムスタンプ}.png
```

例：
- `backtest_train_20250124_143025.png` - 2025年1月24日14時30分25秒実行の学習期間結果
- `backtest_test_20250124_143025.png` - 同時刻実行のテスト期間結果

この命名規則により、複数回実行してもファイルが上書きされることなく、実行履歴を管理できます。

## 技術的詳細

### カルマンフィルター実装

```python
def kalman_ma_model3(close, atr, beta=1.0):
    # 2次元状態空間モデル
    # 状態: [トレンド成分, スムージング成分]
    # 観測: 価格データ
    # 動的Q: ATRベースのプロセスノイズ
```

### PnL計算

ベクトル化された高速PnL計算：
- エントリー時点での価格・ATR記録
- TP/SL条件の連続チェック
- 手数料・スリッページの自動控除
- 期末未決済ポジションの強制決済

### バックテスト信頼性

- **先読み防止**: すべてのシグナルでshift(1)使用
- **リアリスティック執行**: 手数料・スリッページ考慮
- **統計的検証**: PBO分析によるオーバーフィッティング検出

## 注意事項

1. **データ品質**: 1時間足データで1時間間隔の一貫性が必要
2. **計算時間**: 最適化は試行回数に比例して時間がかかります
3. **メモリ使用量**: 大量データ処理時は十分なRAMが必要
4. **パフォーマンス**: 過去実績は将来の結果を保証しません

## 依存関係

- Python 3.11+
- pandas
- numpy
- optuna
- matplotlib
- scikit-learn（オプション）

## 履歴

- **v1 (kalman_ma.py)**: 基本カルマンMA実装
- **v2 (kalman_ma_optv2.py)**: 手数料考慮、多目的最適化
- **v3 (kalman_ma_optv3.py)**: Calmar比率、PBO、固定グリッド、トレーリングストップ
- **Current (kfma_core.py + run_backtest.py)**: モジュール化、純粋関数設計

## ⚠️ 重要な免責事項

**このソフトウェアは教育・研究目的のみで開発されたものです。実際の投資や取引での使用は推奨されません。**

### 教育目的について
- このコードは金融工学、データサイエンス、アルゴリズム開発の学習を目的としています
- カルマンフィルターの応用例として学術的価値を提供することを意図しています
- プログラミング技術の向上と金融データ分析手法の理解促進が主目的です

### 投資リスクに関する警告
1. **過去の実績は将来の結果を保証しません**
   - バックテスト結果は過去データに基づく理論的計算です
   - 実際の市場では様々な要因により結果が大きく異なる可能性があります

2. **暗号資産取引の高リスク性**
   - ビットコインを含む暗号資産は極めて高いボラティリティを持ちます
   - 価格は短期間で大幅に変動し、投資元本を大きく下回る可能性があります
   - 規制環境の変化により市場が大きく影響を受ける可能性があります

3. **アルゴリズム取引の限界**
   - 市場環境の急変時にアルゴリズムが機能しない可能性があります
   - システム障害、ネットワーク遅延等の技術的リスクが存在します
   - 流動性不足により想定通りの執行ができない場合があります

### 技術的制約
- このコードは簡易的な実装であり、本格的な取引システムに必要な機能が不足しています
- エラーハンドリング、異常値処理、リアルタイム処理等が限定的です
- 取引所API、注文執行、ポジション管理機能は含まれていません

### 使用上の注意
- コードの修正・改良により結果が変わる可能性があります
- パラメータ調整は過学習（オーバーフィッティング）を引き起こす可能性があります
- 実装に誤りが含まれている可能性を排除できません

### 責任の限界
**開発者および関係者は以下について一切の責任を負いません：**
- このコードの使用により生じた一切の損失
- 投資判断の結果として発生した財務的損害
- システム障害やデータ誤りによる損失
- 第三者への影響や損害

### 適切な投資について
投資を検討される場合は：
- 金融の専門知識を持つアドバイザーにご相談ください
- 失っても問題のない余剰資金の範囲内で行ってください
- 十分な調査と検討を行った上で自己責任で判断してください
- 分散投資によりリスクを適切に管理してください

### ライセンスと利用条件
このソフトウェアを使用することで、上記の免責事項および制約事項に同意したものとみなされます。商用利用、再配布、改変を行う場合は適用されるライセンス条項を確認してください。

---

このシステムは研究・教育目的で開発されており、実際の取引での使用には十分な検証とリスク管理が必要です。